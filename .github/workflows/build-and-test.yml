name: Build and Test RPM

on:
  push:
    branches: [ main, master ]
  pull_request:
    branches: [ main, master ]
  schedule:
    # Check for new versions daily at 2 AM UTC
    - cron: '0 2 * * *'
  workflow_dispatch:

env:
  WIFIMAN_DOWNLOAD_URL: https://desktop.wifiman.com
  PACKAGE_NAME: wifiman-desktop

permissions:
  contents: read
  issues: write
  pull-requests: read

jobs:
  check-version:
    name: Check for new WiFiman version
    runs-on: [self-hosted, linux, x64]
    outputs:
      current_version: ${{ steps.check.outputs.current_version }}
      latest_version: ${{ steps.check.outputs.latest_version }}
      version_changed: ${{ steps.check.outputs.version_changed }}
      release_exists: ${{ steps.check_release.outputs.result }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Install dependencies
        run: |
          # Dependencies should already be available on the runner
          # curl and grep are standard tools
          which curl || echo "curl not found"
          which grep || echo "grep not found"

      - name: Check current version in spec file
        id: check
        run: |
          # Extract current version from spec file
          CURRENT_VERSION=$(grep "^Version:" wifiman-desktop.spec | awk '{print $2}')
          echo "current_version=$CURRENT_VERSION" >> $GITHUB_OUTPUT
          echo "Current version in spec: $CURRENT_VERSION"
          
          # Get latest version from manifest.json
          MANIFEST_URL="https://desktop.wifiman.com/wifiman-desktop-linux-manifest.json"
          LATEST_VERSION=$(curl -s "$MANIFEST_URL" | grep -oP '"version"\s*:\s*"\K[^"]+' | head -1)
          
          if [ -z "$LATEST_VERSION" ]; then
            echo "Warning: Could not fetch latest version from manifest"
            LATEST_VERSION="unknown"
            VERSION_CHANGED="unknown"
          else
            echo "Latest version from manifest: $LATEST_VERSION"
            
            if [ "$CURRENT_VERSION" != "$LATEST_VERSION" ]; then
              echo "New version available: $CURRENT_VERSION → $LATEST_VERSION"
              VERSION_CHANGED="true"
            else
              echo "Already up to date!"
              VERSION_CHANGED="false"
            fi
          fi
          
          echo "latest_version=$LATEST_VERSION" >> $GITHUB_OUTPUT
          echo "version_changed=$VERSION_CHANGED" >> $GITHUB_OUTPUT

      - name: Check if release already exists
        id: check_release
        if: steps.check.outputs.version_changed == 'true'
        uses: actions/github-script@v7
        with:
          script: |
            const version = '${{ steps.check.outputs.latest_version }}';
            const tag = `v${version}`;
            
            try {
              const release = await github.rest.repos.getReleaseByTag({
                owner: context.repo.owner,
                repo: context.repo.repo,
                tag: tag
              });
              console.log(`Release ${tag} already exists`);
              return 'true';
            } catch (error) {
              if (error.status === 404) {
                console.log(`Release ${tag} does not exist yet`);
                return 'false';
              }
              throw error;
            }
          result-encoding: string

  build-and-test:
    name: Build & Test on Fedora ${{ matrix.fedora_version }}
    runs-on: [self-hosted, linux, x64]
    needs: check-version
    # Only build if there's a new version AND no release exists yet, OR if manually triggered
    if: (needs.check-version.outputs.version_changed == 'true' && needs.check-version.outputs.release_exists != 'true') || github.event_name == 'workflow_dispatch'
    strategy:
      fail-fast: false
      matrix:
        fedora_version: [39, 40, 41, 42, 43]
        arch: [x86_64]
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Update spec file version
        if: needs.check-version.outputs.version_changed == 'true'
        run: |
          LATEST_VERSION="${{ needs.check-version.outputs.latest_version }}"
          echo "Updating spec file to version $LATEST_VERSION"
          sed -i "s/^Version:.*/Version:  $LATEST_VERSION/" wifiman-desktop.spec
          sed -i "s/^Release:.*/Release:  1/" wifiman-desktop.spec
          
          # Update changelog
          TODAY=$(date +"%a %b %d %Y")
          sed -i "/%changelog/a * $TODAY GitHub Actions <actions@github.com> $LATEST_VERSION-1\\n- Automated update to version $LATEST_VERSION\\n" wifiman-desktop.spec
          
          echo "Updated spec file:"
          grep -A 2 "^Version:" wifiman-desktop.spec

      - name: Build and test RPM in Fedora ${{ matrix.fedora_version }} container
        run: |
          # Create a temporary container to build in
          CONTAINER_ID=$(docker run -d \
            -w /build \
            fedora:${{ matrix.fedora_version }} \
            tail -f /dev/null)
          
          # Copy workspace files into container
          docker cp "${{ github.workspace }}/." "$CONTAINER_ID:/build/"
          
          # Run the build script
          docker exec "$CONTAINER_ID" /bin/bash -c '
              set -e
              
              echo "=== Setting up build environment ==="
              dnf install -y rpm-build rpmdevtools dnf-plugins-core
              dnf builddep -y wifiman-desktop.spec
              
              echo "=== Setting up build directory ==="
              rpmdev-setuptree
              
              echo "=== Downloading source files ==="
              spectool -g -R wifiman-desktop.spec
              
              echo "=== Copying patches ==="
              cp *.patch ~/rpmbuild/SOURCES/
              
              echo "=== Building SRPM ==="
              rpmbuild -bs wifiman-desktop.spec
              
              echo "=== Building RPM ==="
              rpmbuild -bb wifiman-desktop.spec
              
              echo "=== Build complete - listing artifacts ==="
              echo "SRPMS:"
              ls -lh ~/rpmbuild/SRPMS/
              echo "RPMS:"
              ls -lh ~/rpmbuild/RPMS/*/
              
              echo "=== Testing installation ==="
              RPM_FILE=$(find ~/rpmbuild/RPMS -name "wifiman-desktop-*.rpm" -type f ! -name "*.src.rpm" | head -1)
              if [ -z "$RPM_FILE" ]; then
                echo "ERROR: No RPM file found"
                exit 1
              fi
              
              echo "Installing: $RPM_FILE"
              dnf install -y "$RPM_FILE"
              
              echo "Verifying package installation..."
              rpm -qi wifiman-desktop
              
              if [ ! -f /opt/wifiman-desktop/wifiman-desktop ]; then
                echo "ERROR: Binary not found"
                exit 1
              fi
              
              if [ ! -f /usr/lib/systemd/system/wifiman-desktop.service ]; then
                echo "ERROR: Service file not found"
                exit 1
              fi
              
              if [ ! -f /usr/share/applications/wifiman-desktop.desktop ]; then
                echo "ERROR: Desktop file not found"
                exit 1
              fi
              
              dnf install -y desktop-file-utils
              desktop-file-validate /usr/share/applications/wifiman-desktop.desktop
              
              echo "✓ Installation test PASSED"
              
              echo "=== Testing uninstallation ==="
              dnf remove -y wifiman-desktop
              
              if rpm -q wifiman-desktop &>/dev/null; then
                echo "ERROR: Package still installed after removal"
                exit 1
              fi
              
              echo "✓ Uninstallation test PASSED"
              
              echo "=== Preparing artifacts ==="
              mkdir -p /build/rpmbuild/{SRPMS,RPMS}
              cp ~/rpmbuild/SRPMS/* /build/rpmbuild/SRPMS/ 2>/dev/null || true
              cp -r ~/rpmbuild/RPMS/* /build/rpmbuild/RPMS/ 2>/dev/null || true
            '
          
          # Copy build results back to runner workspace
          docker cp "$CONTAINER_ID:/build/rpmbuild/" "${{ github.workspace }}/rpmbuild/" || true
          
          # Clean up container
          docker rm -f "$CONTAINER_ID" || true

      - name: Upload RPM artifacts
        uses: actions/upload-artifact@v4
        with:
          name: rpm-fedora-${{ matrix.fedora_version }}-${{ matrix.arch }}
          path: |
            ~/rpmbuild/RPMS/*/*.rpm
            ~/rpmbuild/SRPMS/*.rpm
          retention-days: 30

  create-release:
    name: Create GitHub Release
    runs-on: [self-hosted, linux, x64]
    needs: [check-version, build-and-test]
    if: needs.check-version.outputs.version_changed == 'true' && needs.check-version.outputs.release_exists != 'true'
    steps:
      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: ./artifacts

      - name: Create Release
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const path = require('path');
            const version = '${{ needs.check-version.outputs.latest_version }}';
            const tag = `v${version}`;
            
            // Create release
            const release = await github.rest.repos.createRelease({
              owner: context.repo.owner,
              repo: context.repo.repo,
              tag_name: tag,
              name: `wifiman-desktop ${version}`,
              body: `## wifiman-desktop v${version}\n\nRPM packages for Fedora 39, 40, 41, 42, 43\n\n### Installation\n\`\`\`bash\ndnf install wifiman-desktop-${version}-*.rpm\n\`\`\`\n\n### Source\nOfficial release: https://desktop.wifiman.com/`,
              draft: false,
              prerelease: false
            });
            
            console.log(`Created release: ${release.data.html_url}`);
            
            // Upload RPM artifacts to release
            const artifactsDir = './artifacts';
            
            // Find and upload all RPM files
            const walk = async (dir) => {
              const files = fs.readdirSync(dir);
              for (const file of files) {
                const filePath = path.join(dir, file);
                const stat = fs.statSync(filePath);
                if (stat.isDirectory()) {
                  await walk(filePath);
                } else if (file.endsWith('.rpm')) {
                  const data = fs.readFileSync(filePath);
                  await github.rest.repos.uploadReleaseAsset({
                    owner: context.repo.owner,
                    repo: context.repo.repo,
                    release_id: release.data.id,
                    name: file,
                    data: data
                  });
                  console.log(`Uploaded: ${file}`);
                }
              }
            };
            
            await walk(artifactsDir);

  summary:
    name: Build Summary
    runs-on: [self-hosted, linux, x64]
    needs: [check-version, build-and-test]
    if: always()
    steps:
      - name: Generate summary
        run: |
          echo "## Build and Test Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Version Information" >> $GITHUB_STEP_SUMMARY
          echo "- Current version: ${{ needs.check-version.outputs.current_version }}" >> $GITHUB_STEP_SUMMARY
          echo "- Latest version: ${{ needs.check-version.outputs.latest_version }}" >> $GITHUB_STEP_SUMMARY
          echo "- Version changed: ${{ needs.check-version.outputs.version_changed }}" >> $GITHUB_STEP_SUMMARY
          echo "- Release exists: ${{ needs.check-version.outputs.release_exists }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Build and Test Status" >> $GITHUB_STEP_SUMMARY
          echo "- Fedora 39, 40, 41, 42, 43: ${{ needs.build-and-test.result }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Each version was built and tested on its matching Fedora image." >> $GITHUB_STEP_SUMMARY
          echo "### Build and Test Status" >> $GITHUB_STEP_SUMMARY
          echo "- Fedora 39, 40, 41, 42, 43: ${{ needs.build-and-test.result }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Each version was built and tested on its matching Fedora image." >> $GITHUB_STEP_SUMMARY
